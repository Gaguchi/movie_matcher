{% extends 'home/Layout_v2.html' %}
{% load static %} <!-- Replace with your base template -->

{% block content %}
{% if user.is_authenticated %}
	<!-- Page Content Start -->
	<div class="page-content space-top p-b65">
		<div class="container fixed-full-area">
			<div id="root" class="dzSwipe_card-cont dz-gallery-slider" style="display:contents">
    <script type="text/javascript">
        document.addEventListener("DOMContentLoaded", function() {
            if (typeof initReactApp === 'function') {
                initReactApp();
            }
        });
    </script>
    {% verbatim %}
    <script type="text/babel">

        function initReactApp() {
            const { useState, useEffect } = React;
            const options = {
                method: 'GET',
                headers: {
                    accept: 'application/json',
                    Authorization: 'Bearer eyJhbGciOiJIUzI1NiJ9.eyJhdWQiOiJhMTg3OWI0OTI1MTE2NzBmMDNmNWI1Y2M5ZWI2ZTQzNSIsInN1YiI6IjY1MzAwNDA5OWQ1OTJjMDBhZTlmMjdkMyIsInNjb3BlcyI6WyJhcGlfcmVhZCJdLCJ2ZXJzaW9uIjoxfQ.RYPMM01Ei_X917bnfjd4M353M2nXYsioz1RPhS1Zoxo'
                }
            };

            const getRandomPage = () => Math.floor(Math.random() * 400) + 1;

            const MovieInfo = ({ movie, onLikedClick, onDislikedClick, onImageError  }) => {
                if (!movie) return null;

                const truncatedOverview = movie && movie.overview && movie.overview.length > 150 
                    ? `${movie.overview.substring(0, 150)}...` 
                    : movie && movie.overview || '';
                
                if (movie && movie.backdrop_path) {
                    document.body.style.backgroundImage = `url(https://image.tmdb.org/t/p/w1920_and_h800_multi_faces${movie.backdrop_path})`;
                }
            
                return (     
				<div class="dzSwipe_card">
					<div class="dz-media">
                        <img 
                            src={`https://image.tmdb.org/t/p/w300_and_h450_bestv2${movie.poster_path}`} 
                            className="card-img-top" 
                            alt={movie.title} 
                            onError={onImageError}
                        /></div>
					
					<div class="dz-content">
						<div class="left-content style-2">
							<span class="badge style-3 mb-2">Release Date: {movie.release_date}</span>
                            <h4 class="title"><a href={`movie_match/movie_profile/${movie.id}`}>{movie.title}</a></h4>
							<p><i class="icon feather icon-map-pin"></i>Vote Average: {movie.vote_average}</p>		
                            <div class="meta-btn">
                                <a href="javascript:void(0);" class="btn btn-danger rounded-xl w-100" onClick={() => onDislikedClick(movie)}>
                                    Seen: Disliked<i class="feather icon-x"></i>
                                </a>
                                <a href="javascript:void(0);" class="btn btn-info rounded-xl w-100" onClick={() => onLikedClick(movie)}>
                                    Seen: Liked<i class="feather icon-heart-on"></i>
                                </a>
                            </div>			
						</div>
					</div>
					<div class="dzSwipe_card__option dzReject">
						<i class="fa-solid fa-xmark"></i>
					</div>
					<div class="dzSwipe_card__option dzLike">
						<i class="fa-solid fa-check"></i>
					</div>
					<div class="dzSwipe_card__drag"></div>
				</div>
                );
            };
            

            const App = () => {
                const [sortOption, setSortOption] = React.useState('popularity.desc');
                const [movies, setMovies] = useState([]);
                const [topIndex, setTopIndex] = useState(0);
                const [bottomIndex, setBottomIndex] = useState(1);
                const [startX, setStartX] = useState(0);
                const [currentX, setCurrentX] = useState(0);
                const [isSwiping, setIsSwiping] = useState(false);
                const [isMeaningfulSwipe, setIsMeaningfulSwipe] = useState(false);
                const [seenLiked, setSeenLiked] = useState(false);
                const [seenDisliked, setSeenDisliked] = useState(false);

                const [lastFetchTime, setLastFetchTime] = useState(0);

                const handleLikedClick = (movie) => {
                    sendSwipeDataToServer(movie, false, false, true, false);
                    moveToNextMovie();
                };
                
                const handleDislikedClick = (movie) => {
                    sendSwipeDataToServer(movie, false, false, false, true);
                    moveToNextMovie();
                };
            
                const moveToNextMovie = () => {
                    setBottomIndex(prevBottomIndex => prevBottomIndex + 1);
                    setTopIndex(prevTopIndex => {
                        const newTopIndex = prevTopIndex + 1;
                        if (newTopIndex > movies.length - 3) {
                            fetchMovies();
                        }
                        return newTopIndex;
                    });
                };

                const handleImageError = () => {
                    // Skip the current movie
                    moveToNextMovie();
                };

                const [userMovies, setUserMovies] = useState([]);

                const fetchUserMovies = () => {
                    return fetch('/movie_match/user_movies')
                        .then(response => response.json())
                        .then(userMovies => {
                            setUserMovies(userMovies);
                            console.log('User movies:', userMovies);
                        })
                        .catch(error => {
                            console.error('Error:', error);
                        });
                };

                const fetchMovies = () => {
                    const currentTime = new Date().getTime();

                    // Check if it's been at least 1 second since the last fetch
                    if (currentTime - lastFetchTime >= 1000) {
                        const randomPage = getRandomPage();

                        fetch(`https://api.themoviedb.org/3/discover/movie?include_adult=false&include_video=false&language=en-US&sort_by=${sortOption}`, options)
                            .then(response => response.json())
                            .then(data => {
                                // Exclude the movies that the user has interacted with
                                const moviesToDisplay = data.results.filter(movie => !userMovies.includes(movie));

                                setMovies(prevMovies => [...prevMovies, ...moviesToDisplay]);
                            }, [sortOption])
                            .catch(err => {
                                console.error('Failed to fetch movies:', err);
                            });

                        // Update the last fetch time
                        setLastFetchTime(currentTime);
                    }
                };

                window.applyFetch = function() {
                    // Call the fetchMovies function
                    fetch(`https://api.themoviedb.org/3/discover/movie?include_adult=false&include_video=false&language=en-US&sort_by=${sortOption}`, options)
                        .then(response => response.json())
                        .then(data => {
                            // Update the movies on the page
                            setMovies(data.results);
                        })
                        .catch(error => {
                            console.error('Error:', error);
                        });
                }

                useEffect(() => {
                    fetchUserMovies();
                }, []);

                useEffect(() => {
                    if (userMovies.length > 0) {
                        fetchMovies();
                    }
                }, [userMovies]);

                
                // Filter out the user's movies
                const filteredMovies = movies.filter(movie => !userMovies.includes(movie.id));

                const handleSwipeStyles = () => {
                    if (!isSwiping && !isMeaningfulSwipe) {
                        return { 
                            cardStyle: { transition: 'transform 0.3s ease-out' }, // Animate back to the initial position
                            likeStyle: { opacity: 0 },
                            rejectStyle: { opacity: 0 }
                        };
                    }
                
                    if (!isSwiping) return { likeStyle: { opacity: 0 }, rejectStyle: { opacity: 0 } };
                
                    const translateX = currentX - startX;
                    const rotate = Math.min(translateX / 10, 15);
                    const opacity = Math.min(Math.abs(translateX) / 100, 1); // Calculate opacity based on swipe distance
                
                    return {
                        cardStyle: {
                            transform: `translateX(${translateX}px) rotate(${rotate}deg)`,
                            transition: 'transform 0s' // Apply transition only to transform property
                        },
                        likeStyle: { opacity: translateX > 0 ? opacity : 0 },
                        rejectStyle: { opacity: translateX < 0 ? opacity : 0 }
                    };
                };
                
                
                
                
                const sendSwipeDataToServer = (movie, isInterested, isNotInterested, liked, disliked) => {
                    // Include the movieId in the URL
                    fetch(`/movie_match/save_movie_data/${movie.id}/`, {
                      method: 'POST',
                      headers: {
                        'Content-Type': 'application/json',
                      },
                      body: JSON.stringify({
                        isInterested,
                        isNotInterested,
                        seenLiked: liked,
                        seenDisliked: disliked,
                        movieId: movie.id,
                        title: movie.title,
                        overview: movie.overview,
                        release_date: movie.release_date,
                        popularity: movie.popularity,
                        vote_average: movie.vote_average,
                        original_language: movie.original_language,
                        original_title: movie.original_title,
                        genre_ids: movie.genre_ids,
                        backdrop_path: movie.backdrop_path,
                        poster_path: movie.poster_path,
                        video: movie.video,
                        vote_count: movie.vote_count,
                        adult: movie.adult
                        // Add any other properties you wish to send
                      })
                    })
                    .then(response => response.json())
                    .then(data => {
                      console.log('Successfully sent swipe data:', data);
                    })
                    .catch(err => {
                      console.error('Failed to send swipe data:', err);
                    });
                  };
                  


                const handleMouseOut = () => {
                    // Reset the swipe state
                    setIsSwiping(false);
                    setStartX(0);
                    setCurrentX(0);
                };
                
                // Add a throttle function
                const throttle = (func, limit) => {
                    let inThrottle;
                    return function () {
                        const args = arguments;
                        const context = this;
                        if (!inThrottle) {
                            func.apply(context, args);
                            inThrottle = true;
                            setTimeout(() => inThrottle = false, limit);
                        }
                    };
                };

                // Replace your handleMove function with a throttled version
                const handleMove = throttle((e) => {
                    e.stopPropagation();
                    if (isSwiping) {
                        const movedX = e.clientX || e.touches[0].clientX;
                        setCurrentX(movedX);
                    }
                }, 16); // approx 60 frames per second

                
                
                const handleStart = (e) => {
                    e.stopPropagation();
                    setIsSwiping(true);
                    const initialX = e.clientX || e.touches[0].clientX;
                    setStartX(initialX);
                    setCurrentX(initialX);  // Reset currentX to initialX at start
                    console.log('handleStart:', 'startX set to:', initialX);  // Debugging log
                };
                
                const handleEnd = (e) => {
                    e.stopPropagation();
                    console.log('handleEnd triggered');  // Debugging log
                
                    const swipeDistance = Math.abs(currentX - startX);
                    console.log('Swipe distance:', swipeDistance);  // Debugging log
                
                    if (swipeDistance > 200) {
                        console.log('Meaningful swipe detected');  // Debugging log
                
                        // Determine swipe direction
                        let isInterested;
                        let isNotInterested;
                        if (currentX > startX) {
                            console.log('Swipe right');
                            isInterested = true; 
                        } else {
                            console.log('Swipe left');
                            isNotInterested = true; 
                        }
                
                        setIsMeaningfulSwipe(true);
                
                        setBottomIndex(prevTopIndex => prevTopIndex + 1);
                
                        setTopIndex(prevTopIndex => {
                            const newTopIndex = prevTopIndex + 1;
                            if (newTopIndex > movies.length - 3) {
                                fetchMovies();
                            }
                            return newTopIndex;
                        });
                        
                        const movie = movies[topIndex];
                        if (movie) {
                            sendSwipeDataToServer(movie, isInterested, isNotInterested);  // Note: Passing the entire 'movie' object
                        }
                    } else {
                        console.log('Not a meaningful swipe');  // Debugging log
                        setIsMeaningfulSwipe(false);
                    }
                
                    setIsSwiping(false);
                    setStartX(0);
                    setCurrentX(0);
                };
                
                
                if (movies.length < 2) {
                    return <div>Loading...</div>;
                }
            
                return (
                    <div 
                        className="justify-content-center align-items-center dzSwipe_card-cont dz-gallery-slider"
                        onMouseDown={handleStart}
                        onMouseMove={handleMove}
                        onMouseUp={handleEnd}
                        onMouseOut={handleMouseOut}
                        onTouchStart={handleStart}
                        onTouchMove={handleMove}
                        onTouchEnd={handleEnd}
                    >
                    {[bottomIndex, topIndex].map((index, i) => {
                        const { cardStyle, likeStyle, rejectStyle } = handleSwipeStyles();
                        const isTopCard = index === topIndex;
            
                        return (
                            <div id="card_div"
                                style={{
                                    zIndex: i === 0 ? 1 : 3, // Ensure the bottom card has a lower z-index
                                    ...isTopCard ? cardStyle : {} // Apply swipe styles only to the top card
                                }} 
                                key={`${filteredMovies[index] ? filteredMovies[index].id : index}-${i}`} // Unique key for each card
                            >
                                <MovieInfo movie={filteredMovies[index]} onLikedClick={handleLikedClick} onDislikedClick={handleDislikedClick} onImageError={handleImageError} />
                                {isTopCard && (
                                    <React.Fragment>
                                        <div className="dzSwipe_card__option dzLike" style={likeStyle}>
                                            <i className="fa-solid fa-check"></i>
                                        </div>
                                        <div className="dzSwipe_card__option dzReject" style={rejectStyle}>
                                            <i className="fa-solid fa-xmark"></i>
                                        </div>
                                    </React.Fragment>
                                )}                                
                            </div>
                        );
                    })}
                    <div class="offcanvas offcanvas-bottom container p-0" tabindex="-1" id="settingCanvas">
                        <button type="button" class="btn-close drage-close" data-bs-dismiss="offcanvas" aria-label="Close"></button>
                        <div class="offcanvas-header share-style m-0">
                            <h4 class="title mb-0">Filter</h4>
                            <button type="button" class="btn-close" data-bs-dismiss="offcanvas" aria-label="Close"><i class="fa-solid fa-xmark"></i></button>
                        </div>
                        <div class="offcanvas-body">
                            <div class="show-me mb-3">
                                <h6 class="title">Sort by:</h6>
                                <select value={sortOption} onChange={e => setSortOption(e.target.value)}>
                                    <option value="popularity.desc">Popularity Descending</option>
                                    <option value="popularity.asc">Popularity Ascending</option>
                                    <option value="vote_average.desc">Rating Descending</option>
                                    <option value="vote_average.asc">Rating Ascending</option>
                                </select>
                            </div>
                            <div class="dz-slider">
                                <div class="slider-head">
                                    <h6 class="title mb-0">Age</h6>
                                    <div class="title font-w600 font-16">
                                        <span class="example-val title slider-margin-value-min"></span>
                                        <span class="example-val title slider-margin-value-max"></span>
                                    </div>
                                </div>
                                <div class="slider-body">
                                    <div class="range-slider style-1 w-100">
                                        <div id="slider-tooltips4"></div>
                                    </div>
                                </div>
                            </div>
                            <div class="dz-slider mb-3">
                                <div class="slider-head">
                                    <h6 class="title mb-0">Distance</h6>
                                    <div class="title font-w600 font-16">
                                        <span class="example-val title slider-margin-value-min"></span>
                                        <span class="example-val title slider-margin-value-max"></span>
                                    </div>
                                </div>
                                <div class="slider-body">
                                    <div class="range-slider style-1 w-100">
                                        <div id="slider-tooltips3"></div>
                                    </div>
                                </div>
                            </div>
                            <a  href="javascript:void(0);"  onClick={applyFetch} class="btn btn-primary w-100 rounded-xl" id="apply">Apply</a>
                        </div>
                    </div>    
                    </div>           
                );
            };

            ReactDOM.render(<App />, document.getElementById('root'));
        }

        if (document.readyState === 'complete' || (document.readyState !== 'loading' && !document.documentElement.doScroll)) {
            initReactApp();
        }
    </script>
    
    {% endverbatim %}
			</div>
		</div>
	</div>
	<!-- Page Content End -->
    
	<!--  Setting OffCanvas -->

	<!--  Setting OffCanvas -->
    {% else %}
        <!-- Page Content for Unauthenticated Users -->
        <div class="page-content space-top p-b65">
            <div class="container fixed-full-area">
                <h2>Please log in</h2>
                <div id="login-form" style="display: block;">
                    <!-- Existing login form -->
                    <form action="{% url 'login' %}" method="post">
                        {% csrf_token %}
                        <div class="form-group">
                            <input autofocus class="form-control" type="text" name="username" placeholder="Username">
                        </div>
                        <div class="form-group">
                            <input class="form-control" type="password" name="password" placeholder="Password">
                        </div>
                        <input class="btn btn-primary" type="submit" value="Login">
                    </form>
                    Don't have an account? <a href="{% url 'register' %}" class="fw-bold">Register here.</a>
                </div>
            </div>
        </div>
    {% endif %}
{% endblock %}