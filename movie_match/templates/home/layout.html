{% load static %}

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>{% block title %}Movie Match{% endblock title %}</title>
    <link href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" rel="stylesheet">
    <link href="{% static 'movie_match/css/styles.css' %}" rel="stylesheet">
    <script src="https://unpkg.com/react@17/umd/react.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@17/umd/react-dom.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/babel-standalone@6/babel.min.js"></script>
    {% block head %}{% endblock head %}
</head>
<body>

<header>
    <!-- Navigation Bar -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
        <div class="container">
            <a class="navbar-brand" href="{% url 'index' %}">Movie Match</a>
            <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ml-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="{% url 'index' %}">Home</a>
                    </li>
                    {% if user.is_authenticated %}
                        <li class="nav-item">
                            <a class="nav-link" href="{% url 'logout' %}">Logout</a>
                        </li>
                    {% else %}
                        <li class="nav-item">
                            <a class="nav-link" href="{% url 'login' %}">Login</a>
                        </li>
                    {% endif %}
                </ul>
                <!-- Search Bar -->
                <form class="form-inline my-2 my-lg-0">
                    <input class="form-control mr-sm-2" type="search" placeholder="Search Movies" aria-label="Search">
                    <button class="btn btn-outline-success my-2 my-sm-0" type="submit">Search</button>
                </form>
                
                <button type="button" class="btn btn-primary ml-2" data-toggle="modal" data-target="#addFriendModal" data-add-friend-url-template="{% url 'add_friend' '123' %}">
                    Add Friend
                </button>
                
                
    <div class="modal fade" id="addFriendModal" tabindex="-1" role="dialog" aria-labelledby="addFriendModalLabel" aria-hidden="true">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="addFriendModalLabel">Add a Friend</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <input type="text" class="form-control" id="friendSearch" placeholder="Type a friend's username">
                    <div id="searchResults" class="search-results"></div> <!-- Container for search results -->
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-primary" onclick="searchFriend()">Search</button>
                </div>
            </div>
        </div>
    </div>
            </div>
        </div>
    </nav>
</header>

<main role="main" class="container">
    {% block content %}
    <!-- Content will be overridden by child templates -->
    {% endblock content %}
</main>

<footer class="footer mt-auto py-3 bg-dark">
    <div class="container text-center">
        <span class="text-muted">&copy; 2023 Movie Match. All rights reserved.</span>
    </div>
</footer>


<script src="https://code.jquery.com/jquery-3.6.0.min.js" crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.9.9/dist/umd/popper.min.js" integrity="sha384-eMNCOe7tC1doJGi3F3J5C36XlTfNfCz8nS7l9Tb3Oz0F+JyJl3V3z8njT2O2StRB" crossorigin="anonymous"></script>
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
{% block scripts %}{% endblock scripts %}


<script>
    
function searchFriend() {
    var username = document.getElementById('friendSearch').value;
    $.ajax({
        url: "{% url 'user_search' %}",
        type: "GET",
        data: {
            'username': username
        },
        dataType: 'json',
        success: function(data) {
            // Clear any previous results
            $('#searchResults').empty();
            // Check if we got any data back
            if (data.length > 0) {
                // Loop through the results and append them to the searchResults div
                data.forEach(function(user) {
                    $('#searchResults').append(
                        '<div class="search-result-item">' +
                        '<span>' + user.username + '</span>' +
                        '<button onclick="addFriend(' + user.id + ')">Add Friend</button>' +
                        '</div>'
                    );
                });
            } else {
                $('#searchResults').append('<p>No users found.</p>');
            }
        }
    });
}

function addFriend(userId) {
    // Retrieve the URL template from the button's data attribute and replace the placeholder
    var urlTemplate = $('[data-add-friend-url-template]').data('add-friend-url-template');
    if (!urlTemplate) {
        console.error('URL template is undefined.');
        return;
    }
    var url = urlTemplate.replace('123', userId);

    $.ajax({
        url: url,
        type: "POST",
        dataType: 'json',
        headers: {
            'X-CSRFToken': getCookie('csrftoken')
        },
        success: function(response) {
            alert('Friend added successfully!');
            // Hide the modal after success
            $('#addFriendModal').modal('hide');
        },
        error: function(response) {
            alert('Error adding friend.');
        }
    });
}


// Function to get CSRF token from cookies
function getCookie(name) {
    var cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        var cookies = document.cookie.split(';');
        for (var i = 0; i < cookies.length; i++) {
            var cookie = jQuery.trim(cookies[i]);
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

</script>
</body>
</html>
